#!/bin/bash

if [ "$EUID" -ne 0 ]; then 
  echo "BŁĄD: Uruchom jako root (sudo)."
  exit 1
fi

echo "================================================================"
echo "         RAPORT AUDYTU KONTA LOKALNEGO - RHEL"
echo "         Hostname: $(hostname)"
echo "         Data:     $(date '+%Y-%m-%d %H:%M:%S')"
echo "================================================================"

echo -e "\n[1. LISTA I STATUS LOKALNYCH UŻYTKOWNIKÓW]"
printf "%-18s %-12s %-15s %-20s\n" "Użytkownik" "UID" "Status" "Ostatnie logowanie"
printf "%-18s %-12s %-15s %-20s\n" "----------" "---" "------" "------------------"

while IFS=: read -r user x uid gid desc home shell; do
    # Analizujemy tylko root (0) i konta zwykłych użytkowników (>=1000)
    if [ "$uid" -eq 0 ] || [ "$uid" -ge 1000 ]; then
        
        shadow_line=$(grep "^$user:" /etc/shadow)
        password_field=$(echo "$shadow_line" | cut -d: -f2)
        expire_field=$(echo "$shadow_line" | cut -d: -f8)
        
        # DOMYŚLNIE ZAKŁADAMY, ŻE AKTYWNE
        STATUS="Aktywne"

        # 1. SPRAWDZENIE BLOKADY KONTA (BEZWZGLĘDNE)
        # Jeśli konto wygasło (data w shadow)
        if [ -n "$expire_field" ]; th
            today_epoch=$(($(date +%s) / 86400))
            if [ "$expire_field" -le "$today_epoch" ]; then
                STATUS="Wygasłe"
            fi
        fi

        # Jeśli powłoka to nologin/false (brak możliwości wejścia)
        if [[ "$shell" == *"/nologin" || "$shell" == *"/false" ]]; then
            STATUS="Zablokowane"
        fi

        # 2. SPRAWDZENIE DOSTĘPNOŚCI (HASŁO LUB KLUCZ)
        # Jeśli hasło jest zablokowane (! lub *), sprawdzamy czy są klucze SSH.
        # Jeśli nie ma ani hasła, ani kluczy, a użytkownik nie jest teraz zalogowany -> Zablokowane.
        if [[ "$password_field" == "!"* || "$password_field" == "*"* ]]; then
            # Sprawdź czy użytkownik ma klucze SSH
            has_ssh=false
            [ -f "$home/.ssh/authorized_keys" ] && has_ssh=true
            
            # Sprawdź czy jest aktualnie zalogowany (skoro Ty to robisz, to Twoje konto przejdzie ten test)
            is_logged=false
            who | grep -qw "$user" && is_logged=true

            if [ "$has_ssh" = false ] && [ "$is_logged" = false ]; then
                # Jeśli nie ma hasła, nie ma kluczy i nie jest zalogowany - uznajemy za zablokowane
                STATUS="Zablokowane"
            fi
        fi

        # Pobieranie ostatniego logowania
        last_log_raw=$(lastlog -u "$user" | tail -n 1)
        if [[ "$last_log_raw" == *"Never"* || "$last_log_raw" == *"Nigdy"* ]]; then
            last_log_fmt="Nigdy nie logowany"
        else
            last_log_fmt=$(echo "$last_log_raw" | awk '{for(i=4;i<=NF;i++) printf $i" "; print ""}')
        fi

        printf "%-18s %-12s %-15s %-20s\n" "$user" "$uid" "$STATUS" "$last_log_fmt"
    fi
done < /etc/passwd

echo -e "\n[2. POLITYKI SKŁADNI HASEŁ]"
echo "----------------------------------------------------------------"
PWQ="/etc/security/pwquality.conf"
if [ -f "$PWQ" ]; then
    grep -v '^#' "$PWQ" | grep -E 'minlen|dcredit|ucredit|lcredit|ocredit' || echo "STATUS: Ustawienia domyślne."
fi

echo "----------------------------------------------------------------"
PWQ="/etc/security/pwquality.conf"
# Pobieramy parametry z pliku konfiguracyjnego
MINLEN=$(grep "^minlen" $PWQ | cut -d'=' -f2 | xargs)
DCRED=$(grep "^dcredit" $PWQ | cut -d'=' -f2 | xargs)
UCRED=$(grep "^ucredit" $PWQ | cut -d'=' -f2 | xargs)
LCRED=$(grep "^lcredit" $PWQ | cut -d'=' -f2 | xargs)
OCRED=$(grep "^ocredit" $PWQ | cut -d'=' -f2 | xargs)

# Jeśli puste, podstawiamy standardowe wartości domyślne RHEL
echo "Minimalna długość hasła: ${MINLEN:-8 (Domyślnie)}"
echo "Wymagane cyfry (dcredit): ${DCRED:-0 (Domyślnie)}"
echo "Wymagane wielkie litery (ucredit): ${UCRED:-0 (Domyślnie)}"
echo "Wymagane małe litery (lcredit): ${LCRED:-0 (Domyślnie)}"
echo "Wymagane znaki specjalne (ocredit): ${OCRED:-0 (Domyślnie)}"

echo -e "\nINFO: Wartość ujemna (np. -1) oznacza obowiązkowe wystąpienie min. 1 znaku danego typu."

echo -e "\n[3. BLOKOWANIE KONTA PO BŁĘDNYCH LOGOWANIACH]"
echo "----------------------------------------------------------------"
if grep -q "pam_faillock.so" /etc/pam.d/password-auth; then
    echo "STATUS: Aktywne"
    [ -f /etc/security/faillock.conf ] && grep -v '^#' /etc/security/faillock.conf | grep -E 'deny|unlock_time'
else
    echo "STATUS: Brak blokady (Błąd krytyczny audytu)"
fi

echo -e "\n[4. HISTORIA HASIEŁ]"
echo "----------------------------------------------------------------"
HIST_LINE=$(grep -h "pam_pwhistory.so" /etc/pam.d/system-auth /etc/pam.d/password-auth | head -1)
if [ -n "$HIST_LINE" ]; then
    REM_VAL=$(echo "$HIST_LINE" | tr ' ' '\n' | grep "remember" | cut -d'=' -f2)
    echo "STATUS: Aktywne (Pamięta: $REM_VAL)"
else
    echo "STATUS: Brak (Użytkownik może powtarzać hasła)"
fi

echo -e "\n[5. SZYFROWANIE HASŁA]"
echo "----------------------------------------------------------------"
METHOD=$(grep "^ENCRYPT_METHOD" /etc/login.defs | awk '{print $2}')
echo "Metoda: ${METHOD:-SHA512}"
ID_HASH=$(grep '^root:' /etc/shadow | cut -d: -f2 | cut -c1-3)
echo "Hash ID: $ID_HASH (ID \$6\$ to SHA-512)"

echo -e "\n[6. WYMUSZONA ZMIANA HASŁA]"
echo "----------------------------------------------------------------"
awk -F: '$3 == 0 {print "Wymuszona zmiana dla: " $1}' /etc/shadow || echo "Brak."

echo -e "\n==================== KONIEC RAPORTU ===================="