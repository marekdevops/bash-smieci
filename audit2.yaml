#!/bin/bash

# Sprawdzenie uprawnień
if [ "$EUID" -ne 0 ]; then 
  echo "Uruchom jako root (sudo)."
  exit 1
fi

echo "================================================================"
echo "RAPORT AUDYTU SYSTEMU RHEL (LOKALNY + DOMENOWY)"
echo "================================================================"

echo -e "\n[1. STATUS UŻYTKOWNIKÓW]"
printf "%-15s %-15s %-20s\n" "Użytkownik" "Status Konta" "Ostatnie logowanie"
printf "%-15s %-15s %-20s\n" "----------" "------------" "------------------"

# Pobieramy wszystkich użytkowników (lokalnych i z SSSD/LDAP)
# Filtrujemy, by pominąć typowe konta systemowe bez powłoki
getent passwd | grep -E '/bin/bash|/bin/sh' | while IFS=: read -r user x uid gid desc home shell; do
    
    # Próba pobrania statusu przez 'chage' (działa na lokalnych)
    # Dla domenowych sprawdzamy 'account expiration'
    ACCOUNT_EXP=$(chage -l "$user" 2>/dev/null | grep "Account expires" | cut -d: -f2 | xargs)
    
    # Sprawdzenie blokady w shadow (tylko lokalni)
    SHADOW_STATUS=$(grep "^$user:" /etc/shadow | cut -d: -f2)
    
    # LOGIKA STATUSU:
    if [[ "$SHADOW_STATUS" == "!"* || "$SHADOW_STATUS" == "*"* ]]; then
        STATUS="ZABLOKOWANE"
    elif [[ "$ACCOUNT_EXP" != "never" && -n "$ACCOUNT_EXP" ]]; then
        EXP_EPOCH=$(date -d "$ACCOUNT_EXP" +%s 2>/dev/null)
        TODAY_EPOCH=$(date +%s)
        if [[ -n "$EXP_EPOCH" && "$EXP_EPOCH" -lt "$TODAY_EPOCH" ]]; then
            STATUS="WYGASŁE"
        else
            STATUS="AKTYWNE"
        fi
    else
        # Jeśli nie ma w shadow i nie ma daty wygaśnięcia, a jest w getent - uznajemy za aktywne (np. AD)
        STATUS="AKTYWNE"
    fi

    # Ostatnie logowanie
    LAST_LOG=$(lastlog -u "$user" | tail -n 1 | awk '{print $4,$5,$6,$9}')
    [ -z "$LAST_LOG" ] || [[ "$LAST_LOG" == *"Never"* ]] && LAST_LOG="Nigdy"

    printf "%-15s %-15s %-20s\n" "$user" "$STATUS" "$LAST_LOG"
done

echo -e "\n[2. POLITYKI SYSTEMOWE]"

# Minimalna długość i składnia
echo "--- Składnia haseł (pwquality) ---"
[ -f /etc/security/pwquality.conf ] && grep -E '^minlen|^dcredit|^ucredit|^lcredit|^ocredit' /etc/security/pwquality.conf || echo "Domyślne systemowe"

# Historia haseł
echo -e "\n--- Historia haseł (pamiętanie) ---"
grep -h "pam_pwhistory.so" /etc/pam.d/system-auth /etc/pam.d/password-auth | grep "remember" || echo "Brak ograniczeń historii"

# Blokada po błędach
echo -e "\n--- Blokowanie kont (faillock) ---"
[ -f /etc/security/faillock.conf ] && grep -E '^deny|^unlock_time' /etc/security/faillock.conf || echo "Konfiguracja w PAM"

# Szyfrowanie haseł
echo -e "\n--- Szyfrowanie haseł ---"
grep "^ENCRYPT_METHOD" /etc/login.defs || echo "Metoda: SHA512 (Standard RHEL)"

# Transmisja haseł
echo -e "\n--- Bezpieczeństwo transmisji ---"
echo "Status SSH: $(systemctl is-active sshd)"
echo "Szyfrowanie sesji: Tak (wymuszone przez SSH)"

echo -e "\n================================================================"