#!/bin/bash

if [ "$EUID" -ne 0 ]; then 
  echo "Uruchom jako root (sudo)."
  exit 1
fi

echo "================================================================"
echo "PEŁNY RAPORT AUDYTU SYSTEMU RHEL"
echo "================================================================"

echo -e "\n[1. LISTA I STATUS KONT UŻYTKOWNIKÓW]"
printf "%-18s %-12s %-15s %-20s\n" "Użytkownik" "UID" "Status" "Ostatnie logowanie"
printf "%-18s %-12s %-15s %-20s\n" "----------" "---" "------" "------------------"

getent passwd | grep -E '/bin/bash|/bin/sh' | while IFS=: read -r user x uid gid desc home shell; do
    # Sprawdzenie blokady w shadow
    SHADOW_STATUS=$(grep "^$user:" /etc/shadow | cut -d: -f2)
    
    # Sprawdzenie wygaśnięcia konta
    EXP_DATE=$(chage -l "$user" 2>/dev/null | grep "Account expires" | cut -d: -f2 | xargs)
    
    STATUS="AKTYWNE"
    if [[ "$SHADOW_STATUS" == "!"* || "$SHADOW_STATUS" == "*"* ]]; then
        STATUS="ZABLOKOWANE"
    elif [[ "$EXP_DATE" != "never" && -n "$EXP_DATE" ]]; then
        EXP_EPOCH=$(date -d "$EXP_DATE" +%s 2>/dev/null)
        if [[ -n "$EXP_EPOCH" && "$EXP_EPOCH" -lt $(date +%s) ]]; then
            STATUS="WYGASŁE"
        fi
    fi

    LAST_LOG=$(lastlog -u "$user" | tail -n 1 | awk '{print $4,$5,$6,$9}')
    [[ "$LAST_LOG" == *"Never"* || -z "$LAST_LOG" ]] && LAST_LOG="Nigdy"

    printf "%-18s %-12s %-15s %-20s\n" "$user" "$uid" "$STATUS" "$LAST_LOG"
done

echo -e "\n[2. POLITYKI HASEŁ I SKŁADNI (Complexity)]"
echo "----------------------------------------------------------------"
if [ -f /etc/security/pwquality.conf ]; then
    echo "> Ustawienia z pwquality.conf:"
    grep -E '^minlen|^dcredit|^ucredit|^lcredit|^ocredit|^minclass' /etc/security/pwquality.conf || echo "Brak jawnych wpisów (stosowane domyślne)."
fi
# Dodatkowy check w PAM dla starszych systemów lub specyficznych konfiguracji
echo "> Ustawienia wymuszone w PAM (pam_pwquality/pam_cracklib):"
grep -hE "pam_pwquality.so|pam_cracklib.so" /etc/pam.d/system-auth /etc/pam.d/password-auth | tr ' ' '\n' | grep -E 'minlen|retry|dcredit|ucredit|lcredit|ocredit'

echo -e "\n[3. CZAS ŻYCIA HASŁA (Password Aging)]"
echo "----------------------------------------------------------------"
grep -E '^PASS_MAX_DAYS|^PASS_MIN_DAYS|^PASS_WARN_AGE' /etc/login.defs

echo -e "\n[4. BLOKOWANIE KONTA PO NIEUDANYCH LOGOWANIACH (Account Lockout)]"
echo "----------------------------------------------------------------"
if [ -f /etc/security/faillock.conf ]; then
    grep -E '^deny|^unlock_time|^even_deny_root' /etc/security/faillock.conf
else
    echo "> Parametry faillock bezpośrednio w PAM:"
    grep -h "pam_faillock.so" /etc/pam.d/system-auth /etc/pam.d/password-auth | tr ' ' '\n' | grep -E 'deny|unlock_time|even_deny_root' | sort -u
fi

echo -e "\n[5. HISTORIA HASIEŁ (Password History)]"
echo "----------------------------------------------------------------"
grep -h "pam_pwhistory.so" /etc/pam.d/system-auth /etc/pam.d/password-auth | tr ' ' '\n' | grep "remember" | sort -u || echo "Historia haseł: Nieaktywowana (0)"

echo -e "\n[6. SZYFROWANIE I TRANSMISJA]"
echo "----------------------------------------------------------------"
METHOD=$(grep "^ENCRYPT_METHOD" /etc/login.defs | awk '{print $2}')
echo "Algorytm szyfrowania (login.defs): ${METHOD:-SHA512 (Standard)}"
ID=$(grep '^root:' /etc/shadow | cut -d: -f2 | cut -c1-3)
echo "Identyfikator hash w shadow: $ID ($([[ "$ID" == "\$6\$" ]] && echo "SHA-512" || echo "Inny/Starszy"))"
echo "Logowanie Root przez SSH: $(grep "^PermitRootLogin" /etc/ssh/sshd_config | awk '{print $2}')"

echo -e "\n[7. WYMUSZENIE ZMIANY HASŁA]"
echo "----------------------------------------------------------------"
echo "Użytkownicy z wymuszoną zmianą przy następnym logowaniu:"
awk -F: '$3 == 0 {print "- " $1}' /etc/shadow

echo -e "\n================================================================"
echo "KONIEC RAPORTU"