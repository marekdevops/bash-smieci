#!/bin/bash

if [ "$EUID" -ne 0 ]; then 
  echo "BŁĄD: Uruchom skrypt jako root (sudo), aby mieć dostęp do danych o hasłach."
  exit 1
fi

echo "================================================================"
echo "         RAPORT AUDYTU BEZPIECZEŃSTWA SYSTEMU RHEL"
echo "         Hostname: $(hostname)"
echo "         Data:     $(date '+%Y-%m-%d %H:%M:%S')"
echo "================================================================"
echo -e "\n[1. LISTA I STATUS KONT UŻYTKOWNIKÓW]"
printf "%-18s %-12s %-15s %-20s\n" "Użytkownik" "UID" "Status" "Ostatnie logowanie"
printf "%-18s %-12s %-15s %-20s\n" "----------" "---" "------" "------------------"

getent passwd | grep -E '/bin/bash|/bin/sh|/bin/zsh' | while IFS=: read -r user x uid gid desc home shell; do
    # Sprawdzenie blokady administracyjnej w shadow
    SHADOW_STATUS=$(grep "^$user:" /etc/shadow | cut -d: -f2)
    
    # Sprawdzenie wygaśnięcia konta (chage)
    EXP_DATE=$(chage -l "$user" 2>/dev/null | grep "Account expires" | cut -d: -f2 | xargs)
    
    STATUS="AKTYWNE"
    if [[ "$SHADOW_STATUS" == "!"* || "$SHADOW_STATUS" == "*"* ]]; then
        STATUS="ZABLOKOWANE"
    elif [[ "$EXP_DATE" != "never" && -n "$EXP_DATE" ]]; then
        EXP_EPOCH=$(date -d "$EXP_DATE" +%s 2>/dev/null)
        if [[ -n "$EXP_EPOCH" && "$EXP_EPOCH" -lt $(date +%s) ]]; then
            STATUS="WYGASŁE"
        fi
    fi

    # Pobieranie daty ostatniego logowania
    RAW_LAST_LOG=$(lastlog -u "$user" | tail -n 1)
    if [[ "$RAW_LAST_LOG" == *"Never"* || "$RAW_LAST_LOG" == *"Nigdy"* ]]; then
        LAST_LOG_FMT="Nigdy nie logowany"
    else
        # Wyciągnięcie daty z lastlog (kolumny od 4 wzwyż)
        LAST_LOG_FMT=$(echo "$RAW_LAST_LOG" | awk '{for(i=4;i<=NF;i++) printf $i" "; print ""}')
        if [ -z "$LAST_LOG_FMT" ]; then LAST_LOG_FMT="Nigdy nie logowany"; fi
    fi

    printf "%-18s %-12s %-15s %-20s\n" "$user" "$uid" "$STATUS" "$LAST_LOG_FMT"
done

echo -e "\n[2. POLITYKI SKŁADNI HASEŁ (Pwquality)]"
echo "----------------------------------------------------------------"
PWQ_FILE="/etc/security/pwquality.conf"
if [ -f "$PWQ_FILE" ]; then
    CHECK_PWQ=$(grep -v '^#' "$PWQ_FILE" | grep -E 'minlen|dcredit|ucredit|lcredit|ocredit')
    if [ -z "$CHECK_PWQ" ]; then
        echo "STATUS: Brak specyficznej konfiguracji w $PWQ_FILE (używane domyślne)."
    else
        echo "$CHECK_PWQ"
    fi
fi

echo -e "\n[3. BLOKOWANIE KONTA PO BŁĘDNYCH LOGOWANIACH (Faillock)]"
echo "----------------------------------------------------------------"
FAILLOCK_CONF="/etc/security/faillock.conf"
# Sprawdzenie czy moduł faillock jest obecny w plikach PAM
PAM_CHECK=$(grep -h "pam_faillock.so" /etc/pam.d/system-auth /etc/pam.d/password-auth)

if [ -n "$PAM_CHECK" ]; then
    echo "STATUS: Mechanizm blokowania (pam_faillock) jest WŁĄCZONY."
    if [ -f "$FAILLOCK_CONF" ]; then
        grep -v '^#' "$FAILLOCK_CONF" | grep -E 'deny|unlock_time|even_deny_root' || echo "Parametry domyślne (zwykle 3 próby, 10 min blokady)."
    else
        echo "Szczegóły parametrów bezpośrednio w PAM:"
        echo "$PAM_CHECK" | tr ' ' '\n' | grep -E 'deny|unlock_time' | sort -u
    fi
else
    echo "STATUS: ALARM - Mechanizm blokowania kont po nieudanych próbach jest WYŁĄCZONY."
fi

echo -e "\n[4. HISTORIA HASIEŁ (Pamiętanie poprzednich)]"
echo "----------------------------------------------------------------"
HISTORY_CHECK=$(grep -h "pam_pwhistory.so" /etc/pam.d/system-auth /etc/pam.d/password-auth)

if [ -n "$HISTORY_CHECK" ]; then
    REMEMBER_VAL=$(echo "$HISTORY_CHECK" | tr ' ' '\n' | grep "remember" | head -1 | cut -d'=' -f2)
    echo "STATUS: Mechanizm historii haseł jest WŁĄCZONY."
    echo "System pamięta ostatnie [$REMEMBER_VAL] hasła/hasło użytkownika."
else
    echo "STATUS: ALARM - Historia haseł jest WYŁĄCZONA (użytkownik może używać ciągle tego samego hasła)."
fi

echo -e "\n[5. SZYFROWANIE I TRANSMISJA]"
echo "----------------------------------------------------------------"
METHOD=$(grep "^ENCRYPT_METHOD" /etc/login.defs | awk '{print $2}')
echo "Metoda szyfrowania w login.defs: ${METHOD:-SHA512 (Standard RHEL)}"
ID=$(grep '^root:' /etc/shadow | cut -d: -f2 | cut -c1-3)
echo "Weryfikacja szyfrowania w shadow: $ID (ID \$6\$ = SHA-512 - OK)"
SSH_PERMIT=$(grep "^PermitRootLogin" /etc/ssh/sshd_config | awk '{print $2}')
echo "Logowanie Root przez SSH: ${SSH_PERMIT:-Domyślnie (Prohibit-password)}"

echo -e "\n[6. WYMUSZENIE ZMIANY HASŁA PO 1. LOGOWANIU]"
echo "----------------------------------------------------------------"
FORCED_USERS=$(awk -F: '$3 == 0 {print $1}' /etc/shadow)
if [ -z "$FORCED_USERS" ]; then
    echo "Brak użytkowników z wymuszoną zmianą hasła."
else
    echo "Zmiana hasła przy następnym logowaniu wymuszona dla: $FORCED_USERS"
fi

echo -e "\n================================================================"
echo "KONIEC RAPORTU"