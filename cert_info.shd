#!/bin/bash
#
# Script: cert_info.shd
# Description: WyciÄ…ga certyfikaty z bundla i wyÅ›wietla informacje o nich (uproszczona wersja)
# Author: Marek
# Date: $(date +%Y-%m-%d)
# System: Red Hat Enterprise Linux / CentOS / Fedora
#

# Sprawdzenie czy openssl jest zainstalowane
if ! command -v openssl &> /dev/null; then
    echo "BÅÄ„D: openssl nie jest zainstalowane. Zainstaluj uÅ¼ywajÄ…c:"
    echo "sudo yum install openssl"
    echo "lub"  
    echo "sudo dnf install openssl"
    exit 1
fi

# Funkcja pomocy
show_help() {
    echo "UÅ¼ycie: $0 [OPCJE] NAZWA_CERTYFIKATU PLIK_BUNDLA"
    echo ""
    echo "WyciÄ…ga i wyÅ›wietla informacje o certyfikatach z bundla dla podanej nazwy."
    echo ""
    echo "Argumenty:"
    echo "  NAZWA_CERTYFIKATU  Nazwa certyfikatu do wyszukania (np. example.com)"
    echo "  PLIK_BUNDLA        ÅšcieÅ¼ka do pliku z bundlem certyfikatÃ³w"
    echo ""
    echo "Opcje:"
    echo "  -h, --help         WyÅ›wietl tÄ™ pomoc"
    echo "  -v, --verbose      Tryb szczegÃ³Å‚owy"
    echo "  -d, --days LICZBA  SprawdÅº certyfikaty wygasajÄ…ce w ciÄ…gu podanych dni (domyÅ›lnie: 30)"
    echo "  --debug            Tryb debugowania"
    echo ""
    echo "PrzykÅ‚ady:"
    echo "  $0 bko /etc/ssl/certs/ca-bundle.crt"
    echo "  $0 -d 60 google ./certificates.pem"
    echo "  $0 --debug example /path/to/bundle.pem"
}

# DomyÅ›lne wartoÅ›ci
VERBOSE=false
DEBUG=false
DAYS_WARNING=30

# Parsowanie argumentÃ³w
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        --debug)
            DEBUG=true
            shift
            ;;
        -d|--days)
            DAYS_WARNING="$2"
            if ! [[ "$DAYS_WARNING" =~ ^[0-9]+$ ]]; then
                echo "BÅÄ„D: Liczba dni musi byÄ‡ liczbÄ… caÅ‚kowitÄ…"
                exit 1
            fi
            shift 2
            ;;
        -*)
            echo "Nieznana opcja: $1"
            show_help
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

# Sprawdzenie argumentÃ³w
if [ $# -ne 2 ]; then
    echo "BÅÄ„D: Wymagane sÄ… dokÅ‚adnie dwa argumenty"
    echo ""
    show_help
    exit 1
fi

CERT_NAME="$1"
BUNDLE_FILE="$2"

# Sprawdzenie czy plik bundla istnieje
if [ ! -f "$BUNDLE_FILE" ]; then
    echo "BÅÄ„D: Plik bundla '$BUNDLE_FILE' nie istnieje lub nie jest plikiem"
    exit 1
fi

# Sprawdzenie czy plik jest czytelny
if [ ! -r "$BUNDLE_FILE" ]; then
    echo "BÅÄ„D: Brak uprawnieÅ„ do odczytu pliku '$BUNDLE_FILE'"
    exit 1
fi

# Funkcja do formatowania daty
format_date() {
    local date_str="$1"
    local timestamp=$(date -d "$date_str" +%s 2>/dev/null)
    if [ $? -eq 0 ]; then
        date -d "@$timestamp" '+%Y-%m-%d %H:%M:%S (%A)'
    else
        echo "$date_str"
    fi
}

# Funkcja do obliczania dni do wygaÅ›niÄ™cia
days_until_expiry() {
    local expiry_date="$1"
    local current_timestamp=$(date +%s)
    local expiry_timestamp=$(date -d "$expiry_date" +%s 2>/dev/null)
    
    if [ $? -eq 0 ]; then
        local diff_seconds=$((expiry_timestamp - current_timestamp))
        local diff_days=$((diff_seconds / 86400))
        echo "$diff_days"
    else
        echo "N/A"
    fi
}

# Funkcja do wyÅ›wietlania kolorowego tekstu
print_colored() {
    local color="$1"
    local text="$2"
    case $color in
        red)    echo -e "\033[31m$text\033[0m" ;;
        green)  echo -e "\033[32m$text\033[0m" ;;
        yellow) echo -e "\033[33m$text\033[0m" ;;
        blue)   echo -e "\033[34m$text\033[0m" ;;
        *)      echo "$text" ;;
    esac
}

# GÅ‚Ã³wna logika
echo "==============================================="
print_colored "blue" "ğŸ” Wyszukiwanie certyfikatÃ³w dla: $CERT_NAME"
echo "==============================================="
echo "ğŸ“ Plik bundla: $BUNDLE_FILE"
echo "ğŸ“… Data sprawdzenia: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# Tymczasowy katalog na certyfikaty
TEMP_DIR=$(mktemp -d)
trap 'rm -rf "$TEMP_DIR"' EXIT

echo "ğŸ” Rozdzielanie certyfikatÃ³w z bundla..."

# UÅ¼yj prostej metody AWK do podziaÅ‚u bundla - sprawdzona i niezawodna
awk '
BEGIN { cert_num = 0 }
/-----BEGIN CERTIFICATE-----/ {
    cert_num++
    filename = "'$TEMP_DIR'/cert_" cert_num ".pem"
    print $0 > filename
    in_cert = 1
    next
}
/-----END CERTIFICATE-----/ {
    if (in_cert) {
        print $0 >> filename
        close(filename)
        in_cert = 0
    }
    next
}
in_cert {
    print $0 >> filename
}
END { print "Podzielono na " cert_num " certyfikatÃ³w" }
' "$BUNDLE_FILE"

# Policz ile plikÃ³w certyfikatÃ³w zostaÅ‚o utworzonych
cert_files=($(ls "$TEMP_DIR"/cert_*.pem 2>/dev/null))
total_certs=${#cert_files[@]}

echo "ï¿½ Utworzono $total_certs plikÃ³w certyfikatÃ³w"
echo ""

# Liczniki
found_count=0
expired_count=0  
expiring_soon_count=0

echo "ğŸ” Wyszukiwanie certyfikatÃ³w zawierajÄ…cych: '$CERT_NAME'"
echo ""

# Przeszukaj kaÅ¼dy certyfikat
for cert_file in "${cert_files[@]}"; do
    [ -f "$cert_file" ] || continue
    
    cert_num=$(basename "$cert_file" .pem | sed 's/cert_//')
    
    # SprawdÅº poprawnoÅ›Ä‡ certyfikatu
    if ! openssl x509 -in "$cert_file" -noout 2>/dev/null; then
        [ "$DEBUG" = true ] && echo "âŒ Certyfikat $cert_num: uszkodzony, pomijam"
        continue
    fi
    
    # Pobierz informacje o certyfikacie
    cert_text=$(openssl x509 -in "$cert_file" -text -noout 2>/dev/null)
    cert_subject=$(openssl x509 -in "$cert_file" -subject -noout 2>/dev/null | sed 's/subject=//')
    
    # Debug info
    if [ "$DEBUG" = true ]; then
        echo "ğŸ” Certyfikat $cert_num: $cert_subject"
        echo "   Szukam: '$CERT_NAME'"
    fi
    
    # PROSTE wyszukiwanie - jeÅ›li nazwa wystÄ™puje GDZIEKOLWIEK w certyfikacie
    if echo "$cert_text" | grep -qi "$CERT_NAME"; then
        found_count=$((found_count + 1))
        
        [ "$DEBUG" = true ] && echo "   âœ… ZNALEZIONO!"
        
        echo "ğŸ¯ ZNALEZIONY CERTYFIKAT #$found_count (z pliku cert_$cert_num.pem)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Subject (wÅ‚aÅ›ciciel certyfikatu)
        subject=$(echo "$cert_text" | grep "Subject:" | sed 's/.*Subject: //')
        echo "ğŸ‘¤ WÅ‚aÅ›ciciel: $subject"
        
        # Issuer (wystawca)  
        issuer=$(echo "$cert_text" | grep "Issuer:" | sed 's/.*Issuer: //')
        echo "ğŸ¢ Wystawca: $issuer"
        
        # Serial Number
        serial=$(echo "$cert_text" | grep "Serial Number:" | sed 's/.*Serial Number: *//')
        echo "ğŸ”¢ Numer seryjny: $serial"
            
        # Daty waÅ¼noÅ›ci
        not_before=$(openssl x509 -in "$cert_file" -startdate -noout 2>/dev/null | sed 's/notBefore=//')
        not_after=$(openssl x509 -in "$cert_file" -enddate -noout 2>/dev/null | sed 's/notAfter=//')
        
        echo "ğŸ“… WaÅ¼ny od: $(format_date "$not_before")"
        echo "ğŸ“… WaÅ¼ny do: $(format_date "$not_after")"
        
        # Status certyfikatu
        days_left=$(days_until_expiry "$not_after")
        
        if [ "$days_left" != "N/A" ]; then
            if [ "$days_left" -lt 0 ]; then
                expired_count=$((expired_count + 1))
                print_colored "red" "âš ï¸  STATUS: WYGASÅY (od $((-days_left)) dni)"
            elif [ "$days_left" -le "$DAYS_WARNING" ]; then
                expiring_soon_count=$((expiring_soon_count + 1))
                print_colored "yellow" "âš ï¸  STATUS: WYGASA WKRÃ“TCE (za $days_left dni)"
            else
                print_colored "green" "âœ… STATUS: WAÅ»NY (wygasa za $days_left dni)"
            fi
        else
            print_colored "yellow" "â“ STATUS: Nie moÅ¼na okreÅ›liÄ‡"
        fi
        
        # Subject Alternative Names (SAN)
        san=$(echo "$cert_text" | grep -A5 "Subject Alternative Name:" | grep "DNS:" | sed 's/.*DNS://g' | tr ',' '\n' | sed 's/^[ \t]*//' | head -10)
        if [ ! -z "$san" ]; then
            echo "ğŸŒ Alternatywne nazwy:"
            echo "$san" | while read -r name; do
                [ ! -z "$name" ] && echo "   â€¢ $name"
            done
        fi
        
        # Verbose mode
        if [ "$VERBOSE" = true ]; then
            echo ""
            echo "ğŸ“‹ SZCZEGÃ“ÅOWE INFORMACJE:"
            
            # Algorytm podpisu
            sig_alg=$(echo "$cert_text" | grep "Signature Algorithm:" | head -n1 | sed 's/.*Signature Algorithm: //')
            echo "   ğŸ” Algorytm podpisu: $sig_alg"
            
            # Fingerprint
            fingerprint=$(openssl x509 -in "$cert_file" -fingerprint -sha256 -noout 2>/dev/null | sed 's/SHA256 Fingerprint=//')
            [ ! -z "$fingerprint" ] && echo "   ğŸ‘† SHA256: $fingerprint"
        fi
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
    else
        [ "$DEBUG" = true ] && echo "   âŒ Nie zawiera '$CERT_NAME'"
    fi
done

done

# Podsumowanie
echo ""
echo "ğŸ“Š PODSUMOWANIE"
echo "==============="
echo "ğŸ” Wyszukiwane: '$CERT_NAME'"
echo "ğŸ”¢ Przetworzonych certyfikatÃ³w: $total_certs"
echo "ğŸ“ Bundle: $BUNDLE_FILE"
echo "ğŸ¯ Znaleziono: $found_count certyfikat(y/Ã³w)"

if [ "$found_count" -gt 0 ]; then
    if [ "$expired_count" -gt 0 ]; then
        print_colored "red" "âŒ WygasÅ‚e: $expired_count"
    fi
    if [ "$expiring_soon_count" -gt 0 ]; then
        print_colored "yellow" "âš ï¸  WygasajÄ…ce wkrÃ³tce (â‰¤$DAYS_WARNING dni): $expiring_soon_count"
    fi
    
    valid_count=$((found_count - expired_count - expiring_soon_count))
    if [ "$valid_count" -gt 0 ]; then
        print_colored "green" "âœ… WaÅ¼ne: $valid_count"
    fi
else
    print_colored "yellow" "â„¹ï¸  Brak wynikÃ³w dla '$CERT_NAME'"
    echo ""
    echo "ğŸ’¡ SprÃ³buj:"
    echo "   â€¢ SprawdziÄ‡ pisowniÄ™ nazwy"
    echo "   â€¢ UÅ¼yÄ‡ opcji --debug"
    echo "   â€¢ SprawdziÄ‡ format bundla (musi byÄ‡ PEM)"
fi

echo ""
echo "âœ… ZakoÅ„czono: $(date '+%H:%M:%S')"